#!/usr/bin/env groovy

/**
 *  Fixes the source code according the patch generated by WalkMod and pushes it if tests pass
 */
def call(body) {
    // evaluate the body block, and collect configuration into the object
    def config = [:]
    body.resolveStrategy = Closure.DELEGATE_FIRST
    body.delegate = config
    body()

    def validatePatch = config.validatePatch?:false
    def reportDir = config.reportDir?:'target'
    def branch = config.branch?:'master'
    def mvnHome = config.mvnHome

    if (hasWalkModPatch(mvnHome)){

        if (validatePatch) {
            input "Does the patch look ok?"
        }

        generateWalkModReport reportDir

        applyWalkModPatch

        if(mvnHome != null) {
            sh "${mvnHome}/bin/mvn -DskipWalkmod test"
        }

        pushWalkModPatch branch
    }


}
